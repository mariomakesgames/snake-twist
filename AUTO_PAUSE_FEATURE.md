# 自动暂停功能说明

## 功能概述

当用户在手机上玩游戏时，如果切换到其他应用或回到主屏幕，游戏会自动暂停。当用户重新回到游戏时，需要手动点击屏幕或暂停按钮来恢复游戏。

## 实现原理

### 1. 页面可见性监听
- 使用 `document.addEventListener('visibilitychange', ...)` 监听页面可见性变化
- 当 `document.hidden` 为 `true` 时，表示页面被隐藏（用户切换到其他应用）

### 2. 自动暂停逻辑
```javascript
// 在 App.tsx 中实现
if (document.hidden) {
    // 页面隐藏时自动暂停游戏
    if (!gameState.isPaused && !gameState.isGameOver && snakeScene.isGameActive()) {
        snakeScene.setPauseState(true);
    }
}
```

### 3. 手动恢复
- 页面重新可见时不自动恢复游戏
- 用户需要点击暂停覆盖层或暂停按钮来恢复游戏
- 暂停覆盖层显示 "PAUSED 点击屏幕继续"

### 4. 防重复触发机制
- 添加1秒冷却时间，避免频繁触发
- 正确的事件监听器清理，防止内存泄漏
- 状态标记，避免重复暂停

## 代码修改

### App.tsx
- 添加了页面可见性变化监听
- 只在页面隐藏时自动暂停，不在页面重新可见时自动恢复
- 添加了防重复触发机制和正确的清理函数

### SnakeScene.ts
- 添加了 `isGameActive()` 方法来检查游戏状态
- 添加了 `setPauseState()` 方法来设置暂停状态
- 修改了暂停覆盖层，添加了点击事件处理
- 暂停文本显示为 "PAUSED 点击屏幕继续"

### auto-pause-test.html
- 修复了测试文件中的事件监听器清理问题
- 添加了正确的beforeunload事件处理

## 测试方法

1. 在手机上打开游戏
2. 开始游戏，让蛇开始移动
3. 切换到其他应用（如微信、浏览器等）或按Home键回到主屏幕
4. 等待几秒钟
5. 重新回到游戏页面
6. 检查游戏是否已暂停，并显示暂停覆盖层
7. 点击屏幕或暂停按钮来恢复游戏

## 预期行为

✅ **自动暂停**: 切换到其他应用时，游戏自动暂停
✅ **防重复触发**: 1秒内不会重复触发暂停
✅ **正确清理**: 页面卸载时正确清理事件监听器
✅ **手动恢复**: 回到游戏时需要手动点击恢复
✅ **状态管理**: 正确跟踪暂停状态，避免冲突

## 修复的问题

### 1. 事件监听器重复触发
- **问题**: visibility事件监听器没有正确清理，导致重复触发
- **解决**: 添加了正确的清理函数和防重复触发机制

### 2. 测试文件冲突
- **问题**: auto-pause-test.html中的监听器与App.tsx冲突
- **解决**: 在测试文件中添加了正确的清理机制

### 3. 内存泄漏
- **问题**: 事件监听器和定时器没有正确清理
- **解决**: 添加了beforeunload事件处理来清理资源

## 技术细节

- **冷却时间**: 1秒，防止频繁触发
- **状态标记**: isPausedByVisibility跟踪暂停来源
- **清理机制**: useEffect返回函数确保正确清理
- **测试隔离**: 测试文件独立的事件处理，不影响主应用 